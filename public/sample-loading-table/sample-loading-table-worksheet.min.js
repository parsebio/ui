var samples=0,formErrors=!1,showDownloadBox=!0,renderDownloadTile=!0,targetBarcodedCells=1e5,fieldData={numberOfWells:[],targetedNumberOfBarcodedCells:{},diluentPerIntermediate:[],dilutionVolume:[],correctedSample:[],samplePerInputWell:[],samplePerWellDead:[],sampleLocation:[],totalDiluent:[],minDiluentNeeded:0},plateConfiguration={numberOfWells:{},timesSampleCalled:{}};function worksheet_input_update(){calculate_number_barcoded_cells_row().then(calculate_number_of_wells).then(calculate_sample_concentration_row).then(calculate_volume_of_sample_stock_dilution).then(calculate_number_of_wells_k).then(calculate_volume_of_sample_dilution_buffer).then(calculate_number_of_sample_wells).then(calculate_number_of_times_sample_called).then(calculate_sample_per_input_well).then(calculate_sample_per_intermediate).then(calculate_corrected_sample).then(calculate_diluent_per_intermediate).then(calculate_total_diluent).then(calculate_min_diluent).then(calculate_required_number_of_sample_dilution_tubes).then(calculate_sample_per_well_dead).then(calculate_sample_number).then(calculate_sample_times_called).then(calculate_location).then(loading_table_update_sample_names).then(loading_table_update_min_sample_stock_needed).then(calculate_plate_configuration_values).then(render_plate_configuration).then(create_export_table).then(validate_inputs).then(show_hide_elements)}function step_submit_1(e){e.preventDefault(),0<samples&&(show("#sample-information-tile"),remove_class("#arrow-box-1","current"),add_class("#arrow-box-1","complete"),add_class("#arrow-box-2","current"))}function step_submit_2(e){e.preventDefault(),1==renderDownloadTile?(show("#download-tile"),show("#worksheet-data"),add_class("#arrow-box-2","complete"),remove_class("#arrow-box-2","current"),add_class("#arrow-box-3","current")):(hide("#download-tile"),hide("#worksheet-data"))}function targeted_number_barcoded_cells_update(){targetBarcodedCells=get_value("#number-of-barcoded-cells"),calculate_number_barcoded_cells_row()}function number_of_samples_update(e){e.preventDefault();var t=samples,l=(samples=get_value("#number-of-samples"))-t;if(0<samples&&(document.getElementById("step-submit-1").disabled=!1),0<l){var a="",r="";for(let e=0;e<l;e++)var n=Number(t)+e+1,r=(r=(r=r+("<tr id='row-"+n+"'>")+("<td>"+n+"</td>"))+("<td><input type='text' id='sample-name-"+n+"' class='worksheet-input input-width-100-percent' value='Sample "+n+"' /></td>")+("<td><input type='text' id='percent-of-library-"+n+"' class='worksheet-input restrict-to-numbers percent-of-library input-width-100-percent' /></td>"))+("<td><input type='text' id='stock-concentration-"+n+"' class='worksheet-input worksheet-input-validate restrict-to-numbers input-width-100-percent' value='10,000' /></td>")+"</tr>",a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=a+("<tr id='sample-loading-table-row-"+n+"'>")+("<td>"+n+"</td>"))+("<td><input type='text' disabled id='table-sample-name-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='table-percent-of-library-"+n+"' class='worksheet-input percent-of-library input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='table-stock-concentration-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='number-of-wells-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='targeted-number-barcoded-cells-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='sample-concentration-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='volume-of-sample-stock-dilution-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='number-of-wells-k-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='volume-of-sample-dilution-buffer-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='sample-number-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='number-of-sample-wells-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='number-of-times-sample-called-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='sample-per-well-dead-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='sample-per-input-well-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='sample-per-intermediate-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='diluent-per-intermediate-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='total-diluent-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+("<td><input type='text' disabled id='corrected-sample-"+n+"' class='worksheet-input input-width-100-percent' /></td>"))+("<td><input type='text' disabled id='location-"+n+"' class='worksheet-input input-width-100-percent' /></td>")+"</tr>";append_html("#samples-table-body",a),append_html("#samples-table-user-input-body",r),add_event(".worksheet-input","blur",worksheet_input_update),add_event(".worksheet-input-validate","keyup",worksheet_input_update_validate),add_event(".restrict-to-numbers","keydown",restrict_to_numbers),calculate_number_barcoded_cells_row()}else for(let e=t;e>t-Math.abs(l);e--)remove_elements("#row-"+e),remove_elements("#sample-loading-table-row-"+e),worksheet_input_update()}function restrict_to_numbers(e){(e.ctrlKey||e.metaKey)&&["a","c","v","x"].includes(e.key.toLowerCase())||["Backspace","Tab","ArrowLeft","ArrowRight","Delete","0","1","2","3","4","5","6","7","8","9",".","%",","].includes(e.key)||e.preventDefault()}function worksheet_input_update_validate(){validate_inputs().then(show_hide_elements)}async function calculate_number_barcoded_cells_row(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=get_value("#percent-of-library-"+e),l=Number(t.replace("%",""))/100,t=(l&&set_value("#table-percent-of-library-"+e,t),l*targetBarcodedCells);set_value("#targeted-number-barcoded-cells-"+e,t)}e()})}async function calculate_number_of_wells(){return new Promise(e=>{var t,l=0;for(let e=1;e<=samples;e++){var a=get_value("#percent-of-library-"+e),a=parseFloat(a.replace("%",""))/100,a=Math.floor(48*a);l+=fieldData.numberOfWells[e]=a,set_value("#number-of-wells-"+e,a)}l&&(t=Number(fieldData.numberOfWells[1])+(48-l),set_value("#number-of-wells-1",t),t!=fieldData.numberOfWells[1])&&(fieldData.numberOfWells[1]=t),e()})}async function calculate_sample_concentration_row(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=get_value("#targeted-number-barcoded-cells-"+e),l=fieldData.numberOfWells[e];l&&(t=Math.floor(t/(l/48*192.2)),set_value("#sample-concentration-"+e,t))}e()})}async function calculate_volume_of_sample_stock_dilution(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(remove_commas(get_value("#stock-concentration-"+e))),l=Number(get_value("#sample-concentration-"+e)),a=fieldData.numberOfWells[e],r=0;t&&set_value("#table-stock-concentration-"+e,t),r=(l<t?15.6*l/t<5?5*a*1.4:15.6*l/t*a*1.4:15.6*a*1.4).toFixed(2),set_value("#volume-of-sample-stock-dilution-"+e,r)}e()})}async function calculate_number_of_wells_k(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#volume-of-sample-stock-dilution-"+e)),t=Math.ceil(t/200);set_value("#number-of-wells-k-"+e,t)}e()})}async function calculate_volume_of_sample_dilution_buffer(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#volume-of-sample-stock-dilution-"+e).replace(/,/g,"")),t=(t*Number(remove_commas(get_value("#stock-concentration-"+e)))/Number(get_value("#sample-concentration-"+e).replace(/,/g,""))-t).toFixed(2);set_value("#volume-of-sample-dilution-buffer-"+e,t)}e()})}async function calculate_number_of_sample_wells(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#number-of-wells-k-"+e));set_value("#number-of-sample-wells-"+e,t)}e()})}async function calculate_number_of_times_sample_called(){return new Promise(e=>{for(let e=1;e<=samples;e++);e()})}async function calculate_corrected_sample(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#sample-per-intermediate-"+e)),t=0<Number(get_value("#number-of-wells-"+e))?t<5?5:t:0;set_value("#corrected-sample-"+e,t),fieldData.correctedSample[e]=t}e()})}async function calculate_diluent_per_intermediate(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#corrected-sample-"+e)),t=t*Number(remove_commas(get_value("#stock-concentration-"+e)))/Number(get_value("#sample-concentration-"+e))-t;t<1?t=0:t<2&&(t=2),set_value("#diluent-per-intermediate-"+e,t.toFixed(2)),fieldData.diluentPerIntermediate[e]=Number(t.toFixed(2))}e()})}async function calculate_sample_per_intermediate(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#sample-per-input-well-"+e)),l=fieldData.numberOfWells[e];set_value("#sample-per-intermediate-"+e,(t/l).toFixed(2))}e()})}async function calculate_sample_per_input_well(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(remove_commas(get_value("#stock-concentration-"+e))),l=Number(get_value("#sample-concentration-"+e)),a=Number(get_value("#number-of-wells-"+e)),r=0,r=l<t?15.6*l/t*a:15.6*a;set_value("#sample-per-input-well-"+e,r.toFixed(2)),fieldData.samplePerInputWell[e]=Number(r.toFixed(2))}e()})}async function calculate_total_diluent(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=Number(get_value("#diluent-per-intermediate-"+e))*fieldData.numberOfWells[e];set_value("#total-diluent-"+e,t.toFixed(2)),fieldData.totalDiluent[e]=t.toFixed(2)}e()})}async function calculate_min_diluent(){return new Promise(e=>{var t=0;for(let e=1;e<=samples;e++)t+=Number(get_value("#total-diluent-"+e));set_value("#min-diluent-needed",Math.ceil(t)),fieldData.minDiluentNeeded=Math.ceil(t),e()})}async function calculate_required_number_of_sample_dilution_tubes(){return new Promise(e=>{var t=Math.ceil(fieldData.minDiluentNeeded/1500);t&&(set_value("#required-number-of-sample-dilution-tubes",t),imgPath?replace_html("#sample-dilution-tube-locations",'<img src="'+imgPath+"deck-layout-"+t+'.svg" />'):replace_html("#sample-dilution-tube-locations",'<img src="'+siteUrl+"/wp-content/themes/parse-bioscience/pages/sample-loading-table/sample-loading-table-worksheet/images/deck-layout-"+t+'.svg" />')),e()})}async function calculate_sample_per_well_dead(){return new Promise(e=>{for(let e=1;e<=samples;e++)fieldData.samplePerInputWell[e]/fieldData.numberOfWells[e]<5?fieldData.samplePerWellDead[e]=number_round(5*fieldData.numberOfWells[e]*1.4):fieldData.samplePerWellDead[e]=number_round(1.4*fieldData.samplePerInputWell[e]),set_value("#sample-per-well-dead-"+e,fieldData.samplePerWellDead[e]);e()})}async function calculate_sample_number(){return new Promise(e=>{for(let e=1;e<=samples;e++)set_value("#sample-number-"+e,e);e()})}async function calculate_sample_times_called(){return new Promise(e=>{for(let e=1;e<=samples;e++)set_value("#number-of-times-sample-called-"+e,1);e()})}async function loading_table_update_sample_names(){return new Promise(e=>{for(let e=1;e<=samples;e++){var t=get_value("#sample-name-"+e);set_value("#loading-table-sample-name-"+e,t),set_value("#table-sample-name-"+e,t)}e()})}async function loading_table_update_min_sample_stock_needed(){return new Promise(e=>{for(let e=1;e<=samples;e++)set_value("#loading-table-sample-needed-dilution-"+e,get_value("#volume-of-sample-stock-dilution-"+e));e()})}async function calculate_plate_configuration_values(){return new Promise(e=>{set_value("#plate-configuration-sample-number-1",1),set_value("#plate-configuration-wells-1",fieldData.numberOfWells[1]),set_value("#plate-configuration-times-sample-called-1",1);var t=fieldData.numberOfWells[1],l=1,a=1;for(let e=2;e<=48;e++)l++,set_value("#plate-configuration-times-sample-called-"+e,l),l==t&&(t=fieldData.numberOfWells[++a],l=0);e()})}async function render_plate_configuration(){return new Promise(e=>{var t=fieldData.numberOfWells[1],l=0,a=1,r=1,n=1;for(let e=2;e<=49;e++)l++,set_value("#plate-configuration-"+r+"-"+n,a),a&&(document.getElementById("plate-configuration-cell-"+r+"-"+n).className="",add_class("#plate-configuration-cell-"+r+"-"+n,"plate-configuration-sample-"+a)),l==t&&(t=fieldData.numberOfWells[++a],l=0),12<++n&&(r++,n=1);e()})}async function calculate_location(){return new Promise(e=>{var t=["A","B","C","D","E","F","G"],l=0,a=1;for(let e=1;e<=samples;e++)fieldData.sampleLocation[e]=t[l]+a,set_value("#location-"+e,t[l]+a),12<++a&&(a=1,l++);e()})}async function validate_inputs(){return new Promise(e=>{var t=!1,l="",a=0,r=0;showDownloadBox=!0;for(let e=1;e<=samples;e++){var n=Number(get_value("#percent-of-library-"+e).replace("%",""));n&&r++,n&&n<2.09&&(showDownloadBox=!(t=!0),l+='<div><i class="saphire-icon saphire-icons-ico-exclamation-circle" aria-hidden="true"></i> No individual "Percentage of Library" percentage may be lower than 2.09%</div>'),a+=n,replace_html("#percent-of-library-total",a+"%")}(r==samples&&100!=a?(showDownloadBox=!(t=!0),l+='<div><i class="saphire-icon saphire-icons-ico-exclamation-circle" aria-hidden="true"></i> "Percentage of Library" percentages must add to 100%</div>',add_class):remove_class)("#sample-information-tile","error-100-percent");for(let e=1;e<=samples;e++)get_value(remove_commas("#stock-concentration-"+e))||(showDownloadBox=!1);var i=0;for(let e=1;e<=samples;e++)i+=Number(fieldData.totalDiluent[e]);1800<1.3*i&&(t=!0,l+='<div><i class="saphire-icon saphire-icons-ico-exclamation-circle" aria-hidden="true"></i> "Diluent volumes too high. Extra sample dilution tubes required.</div>'),(1==t?(replace_html("#form-errors-message",l),show):hide)("#form-errors"),e()})}async function show_hide_elements(){return new Promise(e=>{renderDownloadTile=!0;for(let e=1;e<=samples;e++)get_value("#percent-of-library-"+e)||(renderDownloadTile=!1);1!=showDownloadBox&&(renderDownloadTile=!1),document.getElementById("step-submit-2").disabled=1!=renderDownloadTile,e()})}async function create_export_table(){return new Promise(e=>{clear_html("#export-table-body");var t=[],l={},a=[],r=fieldData.numberOfWells[1],n=1,i=0;for(let e=0;e<=47;e++)i++,a[e]=n,i==r&&(r=fieldData.numberOfWells[++n],i=0);l.sampleId=a,l.sourceDeckPosition="A1",l.tipEject=0,l.sourceHeight=31.5,l.sourceSBO=2.5,l.targetMixHeight=0,l.sourceMixCycles=0;var o=l.sourceMixSpeed=0,s=[];for(let t=0;t<=47;t++)if(fieldData.diluentPerIntermediate[t])for(let e=0;e<fieldData.numberOfWells[t];e++)s[o]=fieldData.diluentPerIntermediate[t],o++;l.dilutionVolume=s,l.tipType=[];for(let e=0;e<=47;e++)125<l.dilutionVolume[e]?l.tipType[e]=1250:l.tipType[e]=125;l.sourceMixVolume=[];for(let e=0;e<=47;e++)l.sourceMixVolume[e]=0;var o=0,d=[];l.sourceWell=[];for(let t=0;t<=47;t++)for(let e=0;e<fieldData.numberOfWells[t];e++)d[o]=fieldData.diluentPerIntermediate[t],o++;var u=1500,c=0,m=["F1","E1","D1","C1","B1","A1","F2","E2","D2","C2","B2","A2"];for(let e=0;e<=47;e++)(u-=d[e])<=0&&(u=1500,c<11)&&(c+=1),l.sourceWell[e]=m[c];create_export_table_section(t,l),l.sourceDeckPosition="C",l.tipEject=1,l.sourceHeight=22.4,l.sourceSBO=1.8,l.targetMixHeight=3,l.sourceMixCycles=6,l.sourceMixSpeed=10;o=0,s=[];for(let t=0;t<=47;t++)if(fieldData.correctedSample[t])for(let e=0;e<fieldData.numberOfWells[t];e++)s[o]=fieldData.correctedSample[t],o++;l.dilutionVolume=s;for(let e=0;e<=47;e++)l.tipType[e]=125;l.sourceMixVolume=[];o=0;for(let t=0;t<=47;t++)for(let e=1;e<=fieldData.numberOfWells[t];e++){var p=.6*(fieldData.samplePerWellDead[t]-fieldData.correctedSample[t]*e);125<p?p=125:p<5&&(p=0),l.sourceMixVolume[o]=number_round(p),o++}l.sourceWell=[];o=0;for(let t=0;t<=47;t++)for(let e=0;e<fieldData.numberOfWells[t];e++)l.sourceWell[o]=fieldData.sampleLocation[t],o++;create_export_table_section(t,l),e()})}function create_export_table_section(e,t){var l=["A","B","C","D","E","F","G"],a=0,r=1;for(let e=0;e<=47;e++){var n="",n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n+="<td>Dilution "+t.sampleId[e]+"</td>")+("<td>"+t.sourceDeckPosition+"</td>"))+("<td>"+t.sourceWell[e]+"</td>"))+"<td>B</td>"+("<td>"+l[a]+r+"</td>"))+("<td>"+t.dilutionVolume[e]+"</td>"))+("<td>"+t.tipType[e]+"</td>"))+"<td>8</td>"+"<td>8</td>")+("<td>"+t.sourceMixVolume[e]+"</td>"))+"<td>0</td>"+"<td>N</td>")+("<td>"+t.tipEject+"</td>"))+("<td>"+t.sourceHeight+"</td>"))+("<td>"+t.sourceSBO+"</td>"))+"<td>N</td>"+"<td>22.9</td>")+"<td>2</td>"+"<td>Y</td>")+("<td>"+t.targetMixHeight+"</td>")+"<td>N</td>")+("<td>"+t.sourceMixCycles+"</td>"))+("<td>"+t.sourceMixSpeed+"</td>"))+"<td>0</td>"+"<td>0</td>")+"<td>0</td>"+"<td>0</td>")+"<td>0</td>"+"<td>0</td>")+"<td>0</td>"+"<td>0</td>")+"<td>N</td>"+"<td>0</td>")+"<td>0</td>"+"<td>0</td>")+"<td>2</td>"+"<td>0</td>";append_html("#export-table-body",n),12<++r&&(r=1,a++)}}function download_csv(e){e.preventDefault();e=document.getElementById("export-table").querySelectorAll("tr");let l=[];e.forEach(e=>{e=e.querySelectorAll("th, td");let t=[];e.forEach(e=>t.push('"'+e.innerText.replace(/"/g,'""')+'"')),l.push(t.join(","))});var e="data:text/csv;charset=utf-8,"+l.join("\n"),e=encodeURI(e),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download","sample-loading-table.csv"),document.body.appendChild(t),t.click(),document.body.removeChild(t)}function remove_commas(e){return e.replace(/,/g,"")}document.addEventListener("DOMContentLoaded",function(e){add_event("#step-submit-1","click",step_submit_1),add_event("#step-submit-2","click",step_submit_2),add_event("#number-of-samples","keyup",number_of_samples_update),add_event("#number-of-barcoded-cells","blur",targeted_number_barcoded_cells_update),add_event("#download-csv","click",download_csv),add_event(".restrict-to-numbers","keydown",restrict_to_numbers),document.getElementById("number-of-samples").focus()});